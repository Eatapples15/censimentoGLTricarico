<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protezione Civile - Censimento Fragilità</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --pc-yellow: #fecb00;
            --pc-blue: #003399;
        }
        body { background-color: #f4f6f9; }
        .navbar { background-color: var(--pc-blue); color: white; }
        .navbar-brand { color: var(--pc-yellow) !important; font-weight: bold; }
        .card { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #map { height: 500px; width: 100%; border-radius: 8px; }
        .status-high { color: #dc3545; font-weight: bold; }
        .status-medium { color: #ffc107; font-weight: bold; }
        .hidden-privacy { filter: blur(4px); user-select: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fas fa-shield-alt"></i> PROTEZIONE CIVILE</a>
        <span class="text-white">Sistema Gestione Fragilità Comunali</span>
        <div class="d-flex align-items-center">
            <div class="form-check form-switch text-white me-3">
                <input class="form-check-input" type="checkbox" id="privacyToggle" checked>
                <label class="form-check-label" for="privacyToggle">Modalità Privacy</label>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        
        <div class="col-md-3">
            <div class="card p-3">
                <h5><i class="fas fa-file-upload"></i> Carica Dati</h5>
                <p class="small text-muted">Carica il CSV del censimento.</p>
                <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
                <button class="btn btn-primary w-100" onclick="processFile()">Carica e Analizza</button>
                <hr>
                <div class="alert alert-warning small">
                    <i class="fas fa-lock"></i> <strong>Nota Privacy:</strong> I dati caricati qui vengono elaborati solo nel tuo browser e non vengono inviati a nessun server esterno.
                </div>
            </div>

            <div class="card p-3">
                <h5>Riepilogo</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Totale Censiti
                        <span class="badge bg-primary rounded-pill" id="totalCount">0</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Disabilità Motorie
                        <span class="badge bg-danger rounded-pill" id="motorCount">0</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Supporto Vitale (Elettrico)
                        <span class="badge bg-warning text-dark rounded-pill" id="electroCount">0</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-md-9">
            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-view" type="button">Mappa Operativa</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button">Lista Dettagliata</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="dash-tab" data-bs-toggle="tab" data-bs-target="#dash-view" type="button">Analisi Dati</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="map-view">
                    <div class="card p-2">
                        <div id="map"></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="list-view">
                    <div class="card p-3">
                        <div class="table-responsive">
                            <table class="table table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nominativo</th>
                                        <th>Indirizzo</th>
                                        <th>Tipo Fragilità</th>
                                        <th>Priorità</th>
                                        <th>Contatto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="dash-view">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3">
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3">
                                <canvas id="priorityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- 1. CONFIGURAZIONE INIZIALE ---
    
    // Dati Mock (Esempio se non si carica file)
    let censusData = [
        { id: 1, nome: "Mario Rossi", indirizzo: "Via Roma 10", lat: 41.9028, lng: 12.4964, tipo: "Motoria", priorita: "Alta", telefono: "333-123456" },
        { id: 2, nome: "Luigi Verdi", indirizzo: "Via Milano 5", lat: 41.9035, lng: 12.4970, tipo: "Anziano Solo", priorita: "Media", telefono: "333-789012" },
        { id: 3, nome: "Anna Bianchi", indirizzo: "Piazza Garibaldi 2", lat: 41.9010, lng: 12.4950, tipo: "Elettromedicale", priorita: "Alta", telefono: "333-000000" },
    ];

    let map;
    let markers = [];
    let privacyMode = true;

    // --- 2. INIZIALIZZAZIONE MAPPA ---
    function initMap() {
        // Centrato su Roma (modificare con le coordinate del vostro comune)
        map = L.map('map').setView([41.9028, 12.4964], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        loadDataIntoSystem();
    }

    // --- 3. LOGICA DI CARICAMENTO DATI ---
    function loadDataIntoSystem() {
        // Pulisci marcatori precedenti
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        const tableBody = document.querySelector('#dataTable tbody');
        tableBody.innerHTML = '';
        
        let stats = { motoria: 0, elettro: 0, totale: 0, alta: 0, media: 0, bassa: 0 };

        censusData.forEach(person => {
            stats.totale++;
            if(person.tipo === 'Motoria') stats.motoria++;
            if(person.tipo === 'Elettromedicale') stats.elettro++;
            if(person.priorita === 'Alta') stats.alta++;
            else if(person.priorita === 'Media') stats.media++;
            else stats.bassa++;

            // Aggiungi Marker Mappa
            let color = person.priorita === 'Alta' ? 'red' : 'orange';
            // Nota: Leaflet di base usa icone blu, qui usiamo un cerchio colorato per semplicità
            let marker = L.circleMarker([person.lat, person.lng], {
                color: color,
                fillColor: color,
                fillOpacity: 0.7,
                radius: 10
            }).addTo(map);

            // Popup Mappa (rispetta Privacy)
            let popupContent = `
                <b>${privacyMode ? "Cittadino ID " + person.id : person.nome}</b><br>
                ${person.indirizzo}<br>
                Tipo: ${person.tipo}<br>
                <span class="badge bg-${person.priorita === 'Alta' ? 'danger' : 'warning'}">${person.priorita}</span>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);

            // Popola Tabella
            let row = `
                <tr>
                    <td>${person.id}</td>
                    <td class="${privacyMode ? 'hidden-privacy' : ''}">${person.nome}</td>
                    <td>${person.indirizzo}</td>
                    <td>${person.tipo}</td>
                    <td><span class="badge bg-${person.priorita === 'Alta' ? 'danger' : 'warning'}">${person.priorita}</span></td>
                    <td class="${privacyMode ? 'hidden-privacy' : ''}">${person.telefono}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        // Aggiorna Badge Sidebar
        document.getElementById('totalCount').innerText = stats.totale;
        document.getElementById('motorCount').innerText = stats.motoria;
        document.getElementById('electroCount').innerText = stats.elettro;

        updateCharts(stats);
    }

    // --- 4. GESTIONE GRAFICI ---
    let typeChartInstance = null;
    let priorityChartInstance = null;

    function updateCharts(stats) {
        const ctxType = document.getElementById('typeChart').getContext('2d');
        const ctxPrio = document.getElementById('priorityChart').getContext('2d');

        if(typeChartInstance) typeChartInstance.destroy();
        if(priorityChartInstance) priorityChartInstance.destroy();

        typeChartInstance = new Chart(ctxType, {
            type: 'doughnut',
            data: {
                labels: ['Motoria', 'Elettromedicale', 'Altro'],
                datasets: [{
                    data: [stats.motoria, stats.elettro, stats.totale - stats.motoria - stats.elettro],
                    backgroundColor: ['#dc3545', '#ffc107', '#6c757d']
                }]
            },
            options: { plugins: { title: { display: true, text: 'Distribuzione Fragilità' } } }
        });

        priorityChartInstance = new Chart(ctxPrio, {
            type: 'bar',
            data: {
                labels: ['Alta', 'Media', 'Bassa'],
                datasets: [{
                    label: 'Priorità Intervento',
                    data: [stats.alta, stats.media, stats.bassa],
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                }]
            },
            options: { plugins: { title: { display: true, text: 'Livelli Priorità' } } }
        });
    }

    // --- 5. GESTIONE PRIVACY ---
    document.getElementById('privacyToggle').addEventListener('change', function() {
        privacyMode = this.checked;
        loadDataIntoSystem(); // Ricarica tutto con le nuove impostazioni privacy
    });

    // --- 6. SIMULAZIONE UPLOAD (Funzione Mock) ---
    function processFile() {
        // Qui andrebbe un parser CSV reale (es. PapaParse). 
        // Per ora aggiungiamo dati random per simulare.
        alert("Simulazione: Dati importati con successo.");
        let newId = censusData.length + 1;
        censusData.push({
            id: newId, 
            nome: "Nuovo Utente Importato", 
            indirizzo: "Via Importata " + newId, 
            lat: 41.90 + (Math.random() * 0.01), 
            lng: 12.49 + (Math.random() * 0.01), 
            tipo: "Sensoriale", 
            priorita: "Media", 
            telefono: "N/A"
        });
        loadDataIntoSystem();
    }

    // Avvio applicazione
    window.onload = initMap;
    
    // Fix per Leaflet quando si cambia tab (la mappa deve ricalcolare le dimensioni)
    document.querySelector('button[data-bs-target="#map-view"]').addEventListener('shown.bs.tab', function () {
        map.invalidateSize();
    });

</script>
</body>
</html>
